{% extends "dashboard_base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
{% endblock %}

{% block dashboard_content %}
<section class="dashboard-section">
    <div class="dashboard-container">

        <h2 class="dashboard-title">
            <i class="fas fa-list" style="color:#E94B35;margin-left:8px;"></i>
            جميع الطلبات
        </h2>

        <div class="dashboard-card">
            <div class="card-header">
                <h3><i class="fas fa-clipboard-list"></i> قائمة الطلبات</h3>
            </div>
            <div class="card-body">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>اسم العميل</th>
                            <th>تفاصيل الطلب</th>
                            <th>إجمالي التكلفة</th>
                            <th>الحالة</th>
                            <th>الإجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>{{ order.customer_name|default:"غير محدد" }}</td>
                            <td class="order-details">
                                {% if order.file_name %}
                                <p><strong>الملف:</strong>
                                    <a href="{{ order.file_name.url }}" target="_blank" class="file-link">
                                        {{ order.file_name.name|slice:"10:" }}
                                    </a>
                                </p>
                                {% endif %}
                                <p><strong>نوع الورق:</strong> {{ order.paper_type.paper_type }}</p>
                                <p><strong>الحجم:</strong> {{ order.paper_size }}</p>
                                <p><strong>اللون:</strong> {{ order.printing_color }}</p>
                                <p><strong>عدد الأوراق:</strong> {{ order.number_of_sheets }}</p>
                                <p><strong>الكمية:</strong> {{ order.quantity }}</p>
                                <p><strong>الطباعة:</strong>
                                    {% if order.printing_sides == "one side" %}
                                        وجه واحد
                                    {% else %}
                                        وجهين
                                    {% endif %}
                                </p>
                            </td>
                            <td><span class="price">{{ order.total_cost|default:"0.00" }} جنيه</span></td>
                            <td>
                                <form method="post" action="{% url 'update_order_status' order.id %}">
                                    {% csrf_token %}
                                    <select name="status" onchange="this.form.submit()" class="status-select">
                                        {% for st in all_status %}
                                            <option value="{{ st.id }}" {% if order.status.id == st.id %}selected{% endif %}>
                                                {{ st.status }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </td>
                            <td>
                                <a href="{% url 'order_detail' order.id %}" class="btn-details">عرض الطلب</a>
                                <a href="{% url 'orderchat' order.id %}" class="btn-chat">المحادثة</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">لا توجد طلبات حالياً</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- نافذة منبثقة للتفاصيل -->
        <div id="order-modal" class="order-modal">
            <div class="order-modal-content">
                <span class="close-modal" onclick="closeOrderDetails()">&times;</span>
                <h3>تفاصيل الطلب</h3>
                <div id="order-details-content"></div>
            </div>
        </div>

    </div>
</section>

<script>
function showOrderDetails(btn) {
    const fields = [
        ['اسم العميل', btn.dataset.customer_name],
        ['اسم الملف', btn.dataset.file_name],
        ['نوع الورق', btn.dataset.paper_type],
        ['حجم الورق', btn.dataset.paper_size],
        ['لون الطباعة', btn.dataset.printing_color],
        ['الطباعة على وجه/وجهين', btn.dataset.printing_sides],
        ['عدد النسخ', btn.dataset.quantity],
        ['العنوان', btn.dataset.address],
        ['ملاحظات', btn.dataset.notes],
        ['الحالة', btn.dataset.status],
        ['تاريخ الطلب', btn.dataset.created_at],
        ['تاريخ آخر تعديل', btn.dataset.updated_at],
    ];
    let html = '';
    fields.forEach(([label, value]) => {
        html += `<p><strong>${label}:</strong> ${value || '-'}</p>`;
    });
    document.getElementById('order-details-content').innerHTML = html;
    document.getElementById('order-modal').style.display = 'flex';
}

function closeOrderDetails() {
    document.getElementById('order-modal').style.display = 'none';
}
</script>
{% endblock %}
