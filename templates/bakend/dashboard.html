{% extends "dashboard_base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block dashboard_content %}
<section class="dashboard-section">
    <div class="dashboard-container">

        <h2 class="dashboard-title">
            <i class="fas fa-tachometer-alt" style="color:#E94B35;margin-left:8px;"></i>
            لوحة تحكم الإدارة
        </h2>

        <!-- آخر الطلبات -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3><i class="fas fa-file-alt"></i> آخر الطلبات</h3>
            </div>
            <div class="card-body">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>اسم العميل</th>
                            <th>تفاصيل الطلب</th>
                            <th>إجمالي التكلفة</th>
                            <th>الحالة</th>
                            <th>الإجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td>{{ order.customer_name|default:"غير محدد" }}</td>
                            <td class="order-details">
                                {% if order.file_name %}
                                <p>
                                    <strong>الملف:</strong>
                                    <a href="{{ order.file_name.url }}" target="_blank" class="file-link">
                                        {{ order.file_name.name|slice:"10:" }}
                                    </a>
                                </p>
                                {% endif %}
                                <p><strong>نوع الورق:</strong> {{ order.paper_type.paper_type }}</p>
                                <p><strong>الحجم:</strong> {{ order.paper_size }}</p>
                                <p><strong>اللون:</strong> {{ order.printing_color }}</p>
                                <p><strong>عدد الأوراق:</strong> {{ order.number_of_sheets }}</p>
                                <p><strong>الكمية:</strong> {{ order.quantity }}</p>
                                <p><strong>الطباعة:</strong>
                                    {% if order.printing_sides == "one side" %}
                                        وجه واحد
                                    {% else %}
                                        وجهين
                                    {% endif %}
                                </p>
                            </td>
                            <td><span class="price">{{ order.total_cost|default:"0.00" }} جنيه</span></td>
                            <td>
                                <form method="post" action="{% url 'update_order_status' order.id %}">
                                    {% csrf_token %}
                                    <select name="status" onchange="this.form.submit()" class="status-select">
                                        {% for st in all_status %}
                                            <option value="{{ st.id }}" {% if order.status.id == st.id %}selected{% endif %}>
                                                {{ st.status }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </td>
                            <td>
                                <a href="{% url 'order_detail' order.id %}" class="btn-details">عرض الطلب</a>
                                <a href="{% url 'orderchat' order.id %}" class="btn-chat">المحادثة</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">لا توجد طلبات حالياً</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- أحدث الرسائل -->
        <div class="dashboard-card" style="margin-top: 40px;">
            <div class="card-header">
                <h3><i class="fas fa-envelope"></i> أحدث الرسائل غير المقروءة</h3>
            </div>
            <div class="card-body">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>من</th>
                            <th>الرسالة</th>
                            <th>الطلب</th>
                            <th>التاريخ</th>
                            <th>الإجراء</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for msg in unread_messages %}
                        <tr>
                            <td>{{ msg.sender.username }}</td>
                            <td>{{ msg.message|truncatechars:60 }}</td>
                            <td>{{ msg.order.customer_name|default:"عميل غير معروف" }} (#{{ msg.order.id }})</td>
                            <td>{{ msg.created_at|date:"Y-m-d H:i" }}</td>
                            <td>
                                <a href="{% url 'order_detail' msg.order.id %}" class="btn-details">عرض الطلب</a>
                                <a href="{% url 'orderchat' msg.order.id %}" class="btn-chat">المحادثة</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">لا توجد رسائل جديدة</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</section>
{% endblock %}
